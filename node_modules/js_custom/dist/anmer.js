/**
 * Created by root on 3/29/16.
 *
 * essa API serve para analisar e execultar alguma ação generica prevista para o sistema
 * é usada mais comumente para envio de mensagens para o ajax enviadas pelo php.
 *
 * basta chamar e passar o json que vem do php e ele irá apresentar as mensagens necessarias assim
 * como passagem de mensagem pode ser usada. ver mais detarlhes em  (\Documentaçao\menssages.txt).
 *
 *
 */
var loop = true; //var responsavel para saber estesr no loop ou não...para fazer algumas requisições somente uma vez
var resp; // var responsavel para dizer se vai querer ou não algumas mudanças

var anmer = {
    "analise": function(json){
        console.log(json);
        //ajeitando caso chegue varias requisições de uma vez.. ele vai organizar e execultar idividualmente para a galera
        if((json.match(/{/g).length - 1) > 1){

            var j = json.split('{');
            //limpando array
            if(j[0]=="")j.shift();

            //fazendo a operação para todos as requisiçoes em massa que vem
            for(var i = 0; i< j.length; i++){
                json = JSON.parse("{"+j[i]);//ajeutando o json qeu vem
                run(json);
            }

        }else{// mandando para requisição individual
            json = JSON.parse(json);
            run(json);
        }

    }
};

var run = function(json){
    switch(json.type){
        case "error":
            notification.error(json.message);

            //caso por algum motivo queria redirecionar quando der algum tipo de error só add a atributo 'url'
            setTimeout(function(){
                if(json.url != undefined)
                    window.location.href = json.url;
            },3000);
            break;
        case "ask":
            if(loop)resp = window.confirm(json.message);

            if(resp)
                sendAjax(json.uri, json.method, json.data);
            loop = false;
            break;
        case "success":
            notification.ok(json.message);
            setTimeout(function(){
                if(json.url == undefined)
                    window.location.reload();
                else
                    window.location.href = json.url;
            },3000);
            break;
        default:
            console.log("\nHouve algun erro no json, olha como ele ta vindo |\n\n");
            //console.log(json);
            break;
    }
};

var sendAjax = function(url, method, data){
    $.ajax({
        type: method,
        url: url,
        data: data,
        datatype: 'html',
        success: function(msg){
            console.log("anmer.js --->> "+msg);
            //setTimeout(function(){window.location.reload();}, 1000);
        },
        error: function(){
            notification.ok('Houve algum erro no sistema, talvés seja a internet...');
        }
    });
};